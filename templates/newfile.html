<script>
    // Core state management
    let currentConversationId = null;
    let uploadedFiles = [];
    
    let isListening = false;
    let recognition;
    
    function toggleVoiceInput() {
        const voiceInputBtn = document.getElementById('voiceInputBtn');
        if (!isListening) {
            startVoiceInput();
            voiceInputBtn.classList.add('active');
        } else {
            stopVoiceInput();
            voiceInputBtn.classList.remove('active');
        }
    }
    
    function startVoiceInput() {
        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
    
        recognition.start();
        isListening = true;
    
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            document.getElementById('messageInput').value = transcript;
            stopVoiceInput();
        };
    
        recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            stopVoiceInput();
        };
    
        recognition.onend = () => {
            if (isListening) {
                recognition.start(); // Restart if still listening
            }
        };
    }
    
    function stopVoiceInput() {
        if (recognition) {
            recognition.stop();
        }
        isListening = false;
        document.getElementById('voiceInputBtn').classList.remove('active');
    }
    
    let isSpeaking = false;
    let synthesis;
    
    function toggleVoiceOutput() {
        const voiceOutputBtn = document.getElementById('voiceOutputBtn');
        if (!isSpeaking) {
            startVoiceOutput();
            voiceOutputBtn.classList.add('active');
        } else {
            stopVoiceOutput();
            voiceOutputBtn.classList.remove('active');
        }
    }
    
    function startVoiceOutput() {
        const lastBotMessage = document.querySelector('.bot-message:last-child');
        if (lastBotMessage) {
            const text = lastBotMessage.innerText;
            synthesis = new SpeechSynthesisUtterance(text);
            synthesis.lang = 'en-US';
            synthesis.onend = () => {
                isSpeaking = false;
                document.getElementById('voiceOutputBtn').classList.remove('active');
            };
            synthesis.onerror = (event) => {
                console.error('Speech synthesis error:', event.error);
                isSpeaking = false;
                document.getElementById('voiceOutputBtn').classList.remove('active');
            };
            window.speechSynthesis.speak(synthesis);
            isSpeaking = true;
        }
    }
    
    function stopVoiceOutput() {
        if (synthesis) {
            window.speechSynthesis.cancel();
        }
        isSpeaking = false;
        document.getElementById('voiceOutputBtn').classList.remove('active');
    }
    
    // Initialize when document loads
    document.addEventListener('DOMContentLoaded', () => {
        initializeSidebar();
        loadConversations();
        setupEventListeners();
        initializeSettings();
    });
    
    
    
    // File Handling Functions
    function handleFileSelect(event) {
        const files = event.target.files;
        if (files.length === 0) return;
    
        const fileList = document.getElementById('fileList');
        const spinner = document.getElementById('processingSpinner');
        
        fileList.style.display = 'block';
        fileList.innerHTML = '';
    
        for (const file of files) {
            uploadedFiles.push(file);
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <div>
                    <i class="fas fa-file file-icon"></i>
                    <span>${file.name}</span>
                </div>
                <button class="remove-file" onclick="removeFile('${file.name}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            fileList.appendChild(fileItem);
        }
    
        spinner.style.display = 'block';
        const formData = new FormData();
        for (const file of files) {
            formData.append('files', file);
        }
    
        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            console.log('Files processed:', data);
            spinner.style.display = 'none';
            addMessage('bot', '<i class="fas fa-check-circle me-2"></i> Files processed successfully! You can now ask questions about them.');
        })
        .catch(error => {
            console.error('Error:', error);
            spinner.style.display = 'none';
            addMessage('bot', '<i class="fas fa-exclamation-circle me-2"></i> Error processing files. Please try again.');
        });
    }
    
    function removeFile(fileName) {
        uploadedFiles = uploadedFiles.filter(file => file.name !== fileName);
        const fileList = document.getElementById('fileList');
        const fileItems = Array.from(fileList.getElementsByClassName('file-item'));
        
        fileItems.forEach(item => {
            if (item.querySelector('span').textContent === fileName) {
                item.remove();
            }
        });
    
        if (fileList.children.length === 0) {
            fileList.style.display = 'none';
        }
    
        fetch('/remove-file', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ fileName })
        });
    }
    
    // Sidebar and Event Listeners
    function initializeSidebar() {
        const sidebar = document.querySelector('.sidebar');
        sidebar.innerHTML = `
            <div class="sidebar-actions">
                <button id="newConversationBtn" class="new-conversation-btn">
                    <i class="fas fa-plus"></i>
                    New Chat
                </button>
                <button id="settingsBtn" class="settings-btn">
                    <i class="fas fa-cog"></i>
                    Settings
                </button>
                <button id="logoutBtn" class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
            <div id="conversationList"></div>
        `;
    }
    
    function setupEventListeners() {
        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    
        const newChatBtn = document.getElementById('newConversationBtn');
        if (newChatBtn) {
            newChatBtn.addEventListener('click', createNewConversation);
        }
    
        // Voice button listeners
        document.getElementById('voiceInputBtn').addEventListener('click', toggleVoiceInput);
        document.getElementById('voiceOutputBtn').addEventListener('click', toggleVoiceOutput);
    }
    
    // Conversation Management
    function createNewConversation() {
        fetch('/create_conversation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ title: 'New Chat' })
        })
        .then(response => response.json())
        .then(data => {
            currentConversationId = data.conversation_id;
            clearChatContainer();
            loadConversations();
        });
    }
    
    function loadConversations() {
        fetch('/get_conversations')
            .then(response => response.json())
            .then(data => {
                const conversationList = document.getElementById('conversationList');
                conversationList.innerHTML = '';
                
                data.forEach(conversation => {
                    const conversationItem = document.createElement('div');
                    conversationItem.className = 'history-item';
                    if (conversation.id === currentConversationId) {
                        conversationItem.classList.add('active');
                    }
    
                    const title = conversation.title || 'New Chat';
                    
                    conversationItem.innerHTML = `
                        <i class="fas fa-message"></i>
                        <span class="history-item-title">${title}</span>
                    `;
                    
                    conversationItem.addEventListener('click', () => {
                        document.querySelectorAll('.history-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        conversationItem.classList.add('active');
                        currentConversationId = conversation.id;
                        loadMessages(conversation.id);
                    });
                    
                    conversationList.appendChild(conversationItem);
                });
            });
    }
    
    function loadMessages(conversationId) {
        fetch(`/get_messages/${conversationId}`)
            .then(response => response.json())
            .then(data => {
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.innerHTML = '';
    
                data.forEach(message => {
                    addMessage(message.role, message.message);
                });
                
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
    }
    
    function logout() {
        fetch('/logout', {
            method: 'GET'
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
    
    // Message Handling
    function sendMessage() {
        stopVoiceInput(); // Stop voice input if active
        stopVoiceOutput(); 
        const messageInput = document.getElementById('messageInput');
        stopVoiceInput();
        const message = messageInput.value.trim();
        
        if (!message) return;
    
        if (!currentConversationId) {
            fetch('/create_conversation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ title: message })
            })
            .then(response => response.json())
            .then(data => {
                currentConversationId = data.conversation_id;
                sendMessageToServer(message);
            });
        } else {
            sendMessageToServer(message);
        }
    }
    
    function sendMessageToServer(message) {
        addMessage('user', message);
        const messageInput = document.getElementById('messageInput');
        messageInput.value = '';
        messageInput.style.height = 'auto';
    
        fetch('/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                input: message,
                conversation_id: currentConversationId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                addMessage('bot', data.error);
            } else {
                addMessage('bot', data.response);
                loadConversations();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            addMessage('bot', 'Sorry, there was an error processing your message.');
        });
    }
    
    function addMessage(type, content) {
        const chatContainer = document.getElementById('chatContainer');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}-message`;
        
        if (typeof content === 'string') {
            messageDiv.innerHTML = content;
            
            // Handle text-to-speech for bot messages
            if (type === 'bot' && isSpeaking) {
                startVoiceOutput();
            }
        } else {
            messageDiv.innerHTML = `<pre>${JSON.stringify(content, null, 2)}</pre>`;
        }
        
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    // Settings Management
    function initializeSettings() {
        const settingsBtn = document.getElementById('settingsBtn');
        const modal = document.getElementById('settingsModal');
        const closeBtn = document.querySelector('.close-modal');
        const toggleApiKeyBtn = document.getElementById('toggleApiKey');
        const updateApiKeyBtn = document.getElementById('updateApiKey');
        const apiKeyInput = document.getElementById('apiKeyInput');
    
        settingsBtn.addEventListener('click', () => {
            modal.style.display = 'block';
        });
    
        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });
    
        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    
        toggleApiKeyBtn.addEventListener('click', () => {
            const type = apiKeyInput.type;
            apiKeyInput.type = type === 'password' ? 'text' : 'password';
            toggleApiKeyBtn.innerHTML = `<i class="fas fa-eye${type === 'password' ? '' : '-slash'}"></i>`;
        });
    
        updateApiKeyBtn.addEventListener('click', updateApiKey);
    }
    
    function updateApiKey() {
        const apiKeyInput = document.getElementById('apiKeyInput');
        const newApiKey = apiKeyInput.value.trim();
    
        if (!newApiKey) {
            alert('Please enter an API key');
            return;
        }
    
        fetch('/update_api_key', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                api_key: newApiKey
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('API key updated successfully');
                document.getElementById('settingsModal').style.display = 'none';
                apiKeyInput.value = '';
            } else {
                alert(data.error || 'Failed to update API key');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating API key');
        });
    }
    
    function clearChatContainer() {
        const chatContainer = document.getElementById('chatContainer');
        chatContainer.innerHTML = '';
    }
    
    // Utility functions for handling textarea auto-resize
    function autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    }
    
    // Initialize textarea auto-resize
    document.addEventListener('DOMContentLoaded', () => {
        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('input', () => autoResizeTextarea(messageInput));
    });
    
    // Error handling utility
    function handleError(error, customMessage = 'An error occurred') {
        console.error(error);
        addMessage('bot', `<i class="fas fa-exclamation-circle"></i> ${customMessage}`);
    }
    
    // Markdown processing (if needed)
    function processMarkdown(text) {
        // Add markdown processing logic here if needed
        return text;
    }
        </script>
    
    
    
    